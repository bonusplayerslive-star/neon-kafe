<script>
    const socket = io();
    let adisyonModal;
    let seciliMasa = null;

    // 1. ŞİFRE TANIMLAMA: Sunucudan gelen şifreyi alıyoruz
    // Eğer sunucudan şifre gelmezse varsayılan '12345' olur.
    const GERCEK_SIFRE = "<%= typeof adminPass !== 'undefined' ? adminPass : '12345' %>";

    // 2. GİRİŞ KONTROL FONKSİYONU
    function checkAdminPass() {
        const girilenSifre = document.getElementById('adminPassInput').value; 
        
        if (girilenSifre === GERCEK_SIFRE) {
            localStorage.setItem('adminSifre', girilenSifre);
            adminPaneliAc();
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    }

    // 3. PANELİ AÇAN FONKSİYON
    function adminPaneliAc() {
        document.getElementById('adminLoginOverlay').style.display = 'none';
        document.getElementById('adminMainContent').style.display = 'block';
        socket.emit('admin_giris');
    }

    // 4. SAYFA YÜKLENDİĞİNDE ÇALIŞACAKLAR
    window.addEventListener('DOMContentLoaded', () => {
        // Modal'ı tanımla
        adisyonModal = new bootstrap.Modal(document.getElementById('adisyonModal'));
        
        // Tarayıcı hafızasında şifre varsa otomatik giriş yap
        const kayitliSifre = localStorage.getItem('adminSifre');
        if(kayitliSifre === GERCEK_SIFRE) {
            adminPaneliAc();
        }

        // Enter tuşu ile giriş yapma desteği
        document.getElementById('adminPassInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkAdminPass();
        });
    });

    function cikisYap() {
        localStorage.removeItem('adminSifre');
        location.reload();
    }

    // --- SOCKET DİNLEYİCİLERİ ---
    socket.on('rakamGuncelleme', (data) => {
        document.getElementById('toplam-ciro').innerText = data.ciro.toFixed(2) + " TL";
        document.getElementById('toplam-kar').innerText = data.kar.toFixed(2) + " TL";
    });

    socket.on('yeniSiparisBildirimi', (s) => {
        const liste = document.getElementById('siparis-konteynir');
        if(document.getElementById(`siparis-${s.id}`)) return;

        const div = document.createElement('div');
        div.className = `neon-card siparis-item ${s.durum !== 'bekliyor' ? 'teslim' : ''}`;
        div.id = `siparis-${s.id}`;
        div.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-warning text-dark me-2">MASA ${s.masaNo}</span>
                    <span class="fw-bold">${s.urunAd}</span>
                    <div class="small text-muted">${s.zaman}</div>
                </div>
                ${s.durum === 'bekliyor' ? `<button class="btn btn-sm btn-outline-success" onclick="teslimEt('${s.id}')">TESLİM ET</button>` : `<i class="bi bi-check2-all text-success fs-4"></i>`}
            </div>`;
        liste.prepend(div);
        document.getElementById(`masa-${s.masaNo}`)?.classList.add('dolu');
    });

    socket.on('masa_durum_guncelle', (data) => {
        const masa = document.getElementById(`masa-${data.masaNo}`);
        if(masa) {
            data.durum === 'dolu' ? masa.classList.add('dolu') : masa.classList.remove('dolu');
        }
    });

    function teslimEt(id) {
        socket.emit('siparis_teslim_edildi', id);
        const kart = document.getElementById(`siparis-${id}`);
        if(kart) {
            kart.classList.add('teslim');
            kart.querySelector('button')?.remove();
        }
    }

    function masaDetay(masaNo) {
        socket.emit('masa_detay_iste', masaNo);
    }

    socket.on('masa_detay_verisi', (data) => {
        seciliMasa = data.masaNo;
        const liste = document.getElementById('adisyonIcerik');
        liste.innerHTML = "";
        let toplam = 0;

        if (data.siparisler && data.siparisler.length > 0) {
            data.siparisler.forEach(s => {
                toplam += s.fiyat;
                liste.innerHTML += `<div class="d-flex justify-content-between mb-2"><span>${s.urunAd}</span><span>${s.fiyat} TL</span></div>`;
            });
            document.getElementById('adisyonMasaNo').innerText = `MASA ${data.masaNo} ADİSYON`;
            document.getElementById('adisyonToplam').innerText = `${toplam.toFixed(2)} TL`;
            adisyonModal.show();
        } else {
            alert("Masa boş!");
        }
    });

    document.getElementById('btnHesapOnay').addEventListener('click', () => {
        if(seciliMasa) {
            socket.emit('hesap_kapat', seciliMasa);
            adisyonModal.hide();
        }
    });

    socket.on('masa_sifirla', (masaNo) => {
        document.getElementById(`masa-${masaNo}`)?.classList.remove('dolu');
        const mutfakSiparisleri = document.querySelectorAll(`.siparis-item`);
        mutfakSiparisleri.forEach(item => {
            if(item.innerText.includes(`MASA ${masaNo}`)) item.remove();
        });
    });

    function urunSil(id, ad) {
        if(confirm(`"${ad}" silinsin mi?`)) {
            socket.emit('urun_sil', id);
            document.getElementById(`urun-kart-${id}`).remove();
        }
    }

    function stokGuncellePrompt(id, ad, mevcut) {
        const yeni = prompt(`"${ad}" yeni stok:`, mevcut);
        if(yeni !== null) {
            socket.emit('stok_guncelle', {id, stok: parseInt(yeni)});
            setTimeout(() => { location.reload(); }, 500);
        }
    }

    function gunuKapat() {
        if(confirm("Tüm veriler raporlanıp silinecek! Emin misiniz?")) {
            socket.emit('gunu_kapat');
        }
    }

    socket.on('gun_kapatildi_onayi', () => { 
        alert("Gün kapatıldı."); 
        location.reload(); 
    });
</script>
